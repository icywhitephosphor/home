---
# Main tasks for local role (macOS sing-box)

- name: Validate macOS
  ansible.builtin.assert:
    that:
      - ansible_os_family == "Darwin"
    fail_msg: "This role is only for macOS"

- name: Validate runtime selection
  ansible.builtin.assert:
    that:
      - local_runtime in ['launchd', 'docker', 'brew', 'binary']
      - local_runtime != 'docker' or local_singbox_mode == 'proxy'
    fail_msg: >-
      Invalid runtime '{{ local_runtime }}'. Use: launchd, docker, brew, or binary.
      Docker runtime supports only proxy mode.

- name: Validate VPN secrets
  ansible.builtin.assert:
    that:
      - local_singbox_servers | length > 0
      - local_singbox_outbound_common.tls.server_name | length > 0
    fail_msg: >-
      VPN secrets missing. Copy and fill:
      cp envs/local/group_vars/vpn_secrets.yml.example envs/local/group_vars/vpn_secrets.yml

- name: Create config directory
  ansible.builtin.file:
    path: "{{ local_config_dir }}"
    state: directory
    mode: "0755"

# Parse domain lists from router role files
- name: Parse domain lists
  ansible.builtin.include_tasks: domains.yml

# Generate PAC file
- name: Generate PAC file
  ansible.builtin.include_tasks: pac.yml
  when: local_pac_enabled | default(true)

# Generate sing-box configuration
- name: Generate sing-box configuration
  ansible.builtin.template:
    src: config.json.j2
    dest: "{{ local_config_dir }}/config.json"
    mode: "0600"
    backup: true
  register: _local_config_changed
  notify: "{{ _notify_handlers }}"
  vars:
    _notify_handlers: >-
      {{
        {
          'docker': ['Restart sing-box (docker)'],
          'launchd': ['Restart sing-box (launchd)'],
          'brew': ['Restart sing-box (brew)']
        }.get(local_runtime, [])
      }}

- name: Validate sing-box configuration
  ansible.builtin.command:
    cmd: sing-box check -c {{ local_config_dir }}/config.json
  changed_when: false
  when: local_runtime in ['launchd', 'binary', 'brew']

# Runtime-specific setup
- name: Setup launchd service
  ansible.builtin.include_tasks: launchd.yml
  when: local_runtime == 'launchd'

- name: Setup Docker container
  ansible.builtin.include_tasks: docker.yml
  when: local_runtime == 'docker'

- name: Setup binary runtime
  ansible.builtin.include_tasks: binary.yml
  when: local_runtime == 'binary'

- name: Setup Homebrew service
  ansible.builtin.include_tasks: brew.yml
  when: local_runtime == 'brew'

# Cleanup old files
- name: Cleanup old files
  ansible.builtin.include_tasks: cleanup.yml
  tags: [cleanup]

# Summary
- name: Configuration summary
  ansible.builtin.debug:
    msg: |
      sing-box configured successfully.
      
      Config: {{ local_config_dir }}/config.json
      PAC:    {{ local_pac_path }}
      Mode:   {{ local_singbox_mode }}
      IPv6:   {{ local_ipv6_enabled | default(false) }}
      Proxy:  127.0.0.1:{{ local_proxy_http_port }}
      
      Enabled: {{ local_enabled_domains | join(', ') }}
      Domains: {{ local_routing_domains | length }}
      Servers: {{ local_singbox_servers | map(attribute='name') | join(', ') }}
      
      {% if local_runtime == 'binary' %}
      Start: {{ local_binary_run_script }}
      {% elif local_runtime == 'brew' %}
      Service: brew services info sing-box
      {% elif local_runtime == 'launchd' %}
      Service: launchctl list | grep sing-box
      {% elif local_runtime == 'docker' %}
      Container: docker ps | grep sing-box
      {% endif %}
