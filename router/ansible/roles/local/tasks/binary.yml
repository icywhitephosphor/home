---
- name: Ensure Homebrew is installed
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: local_homebrew_check
  failed_when: not local_homebrew_check.stat.exists

- name: Install sing-box via Homebrew
  ansible.builtin.command: /opt/homebrew/bin/brew install sing-box
  register: local_brew_install_binary
  changed_when: "'Installing' in local_brew_install_binary.stdout"
  failed_when: local_brew_install_binary.rc != 0

- name: Ensure log directory exists for binary runtime
  ansible.builtin.file:
    path: "{{ local_log_file | dirname }}"
    state: directory
    mode: "0755"

- name: Create helper run script
  ansible.builtin.copy:
    dest: "{{ local_binary_run_script }}"
    mode: "0755"
    content: |
      #!/bin/bash
      exec /opt/homebrew/bin/sing-box run -c "{{ local_config_dir }}/config.json"

