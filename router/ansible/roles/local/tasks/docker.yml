---
- name: Ensure Docker is available
  ansible.builtin.command: docker info
  register: local_docker_info
  changed_when: false
  failed_when: local_docker_info.rc != 0 and not ansible_check_mode
  when: not ansible_check_mode

- name: Check that proxy port is free ({{ local_proxy_http_port }})
  ansible.builtin.command: lsof -i TCP:{{ local_proxy_http_port }} -sTCP:LISTEN
  register: local_port_check_http
  changed_when: false
  failed_when: local_port_check_http.rc == 0
  when: not ansible_check_mode

- name: Check that SOCKS port is free ({{ local_proxy_socks_port }})
  ansible.builtin.command: lsof -i TCP:{{ local_proxy_socks_port }} -sTCP:LISTEN
  register: local_port_check_socks
  changed_when: false
  failed_when: local_port_check_socks.rc == 0
  when: not ansible_check_mode

- name: Ensure sing-box container is running (skipped in check mode)
  when: not ansible_check_mode
  block:
    - name: Remove existing sing-box container (if any)
      ansible.builtin.command: docker rm -f {{ local_docker_container_name }}
      register: local_docker_rm
      failed_when: local_docker_rm.rc not in [0, 1]
      changed_when: local_docker_rm.rc == 0

    - name: Run sing-box container
      ansible.builtin.command: >
        docker run -d --name {{ local_docker_container_name }}
        --restart {{ local_docker_restart_policy }}
        --pull always
        -v {{ local_config_dir }}:/config:ro
        -p 127.0.0.1:{{ local_proxy_http_port }}:{{ local_proxy_http_port }}
        -p 127.0.0.1:{{ local_proxy_socks_port }}:{{ local_proxy_socks_port }}
        {{ local_docker_image }}
        run -c /config/config.json
      register: local_docker_run
      changed_when: true
