{# {{ ansible_managed }} #}
{
  "log": {
    "level": "{{ local_singbox_log_level }}",
    "timestamp": true
  },
  "dns": {
    "servers": [
{% for dns in local_singbox_dns_servers %}
      {
        "tag": "{{ dns.tag }}",
{% if dns.type == 'udp' %}
        "type": "udp",
        "server": "{{ dns.server }}"
{% elif dns.type == 'https' %}
        "type": "https",
        "server": "{{ dns.server }}",
        "server_port": {{ dns.server_port | default(443) }},
        "domain_resolver": "{{ dns.domain_resolver }}"
{% endif %}
      }{% if not loop.last %},{% endif %}

{% endfor %}
    ],
    "strategy": "{% if local_ipv6_enabled | default(false) %}prefer_ipv4{% else %}ipv4_only{% endif %}",
    "final": "{{ local_singbox_dns_servers[-1].tag }}"
  },
  "inbounds": [
    {
      "type": "mixed",
      "tag": "mixed-in",
      "listen": "127.0.0.1",
      "listen_port": {{ local_proxy_port }},
      "sniff": true,
      "sniff_override_destination": true
    }
  ],
  "outbounds": [
    {
      "tag": "{{ local_singbox_outbound_common.tag }}",
      "type": "urltest",
      "outbounds": [
{% for server in local_singbox_servers %}
        "{{ server.name }}-v4"{% if (local_ipv6_enabled | default(false)) and server.server_ipv6 | default('') | length > 0 %},
        "{{ server.name }}-v6"{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
      ],
      "url": "https://www.gstatic.com/generate_204",
      "interval": "5m",
      "tolerance": 50
    },
{% for server in local_singbox_servers %}
    {
      "tag": "{{ server.name }}-v4",
      "type": "{{ local_singbox_outbound_common.type }}",
      "server": "{{ server.server }}",
      "server_port": {{ local_singbox_outbound_common.server_port }},
      "uuid": "{{ server.uuid }}"{% if local_singbox_outbound_common.flow %},
      "flow": "{{ local_singbox_outbound_common.flow }}"{% endif %},
      "tls": {
        "enabled": {{ local_singbox_outbound_common.tls.enabled | lower }},
        "insecure": {{ local_singbox_outbound_common.tls.insecure | lower }},
        "server_name": "{{ local_singbox_outbound_common.tls.server_name }}",
        "disable_sni": {{ local_singbox_outbound_common.tls.disable_sni | lower }},
        "utls": {
          "enabled": {{ local_singbox_outbound_common.utls.enabled | lower }},
          "fingerprint": "{{ local_singbox_outbound_common.utls.fingerprint }}"
        },
        "reality": {
          "enabled": {{ local_singbox_outbound_common.reality.enabled | lower }}{% if local_singbox_outbound_common.reality.enabled %},
          "public_key": "{{ server.public_key }}",
          "short_id": "{{ server.short_id }}"{% endif %}

        }
      }
    }{% if (local_ipv6_enabled | default(false)) and server.server_ipv6 | default('') | length > 0 %},
    {
      "tag": "{{ server.name }}-v6",
      "type": "{{ local_singbox_outbound_common.type }}",
      "server": "{{ server.server_ipv6 }}",
      "server_port": {{ local_singbox_outbound_common.server_port }},
      "uuid": "{{ server.uuid }}"{% if local_singbox_outbound_common.flow %},
      "flow": "{{ local_singbox_outbound_common.flow }}"{% endif %},
      "tls": {
        "enabled": {{ local_singbox_outbound_common.tls.enabled | lower }},
        "insecure": {{ local_singbox_outbound_common.tls.insecure | lower }},
        "server_name": "{{ local_singbox_outbound_common.tls.server_name }}",
        "disable_sni": {{ local_singbox_outbound_common.tls.disable_sni | lower }},
        "utls": {
          "enabled": {{ local_singbox_outbound_common.utls.enabled | lower }},
          "fingerprint": "{{ local_singbox_outbound_common.utls.fingerprint }}"
        },
        "reality": {
          "enabled": {{ local_singbox_outbound_common.reality.enabled | lower }}{% if local_singbox_outbound_common.reality.enabled %},
          "public_key": "{{ server.public_key }}",
          "short_id": "{{ server.short_id }}"{% endif %}

        }
      }
    }{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
  ],
  "route": {
    "default_domain_resolver": "{{ local_singbox_dns_servers[-1].tag }}",
    "final": "{{ local_singbox_outbound_common.tag }}",
    "auto_detect_interface": true
  }
}
