---
# defaults file for local role (macOS sing-box)

# ============================================================================
# Runtime Configuration
# ============================================================================

# Режим запуска sing-box:
#   - binary   : установка через Homebrew + скрипт для ручного запуска
#   - brew     : управление через `brew services`
#   - launchd  : macOS LaunchAgent (автозапуск)
#   - docker   : контейнер (только proxy mode)
local_runtime: binary

# Режим работы: proxy (рекомендуется) или tun
local_singbox_mode: proxy

# ============================================================================
# Network Configuration
# ============================================================================

# Порты для proxy mode
local_proxy_http_port: 2080
local_proxy_socks_port: 2081

# ============================================================================
# Paths
# ============================================================================

local_config_dir: "{{ ansible_env.HOME }}/.config/sing-box"
local_brew_config_path: "/opt/homebrew/etc/sing-box/config.json"
local_binary_run_script: "{{ local_config_dir }}/run-sing-box.sh"
local_pac_path: "{{ local_config_dir }}/proxy.pac"

# Log path (varies by runtime)
local_log_file: >-
  {{
    (local_runtime == 'docker') | ternary('/config/sing-box.log',
    (local_runtime == 'brew') | ternary('/opt/homebrew/var/log/sing-box.log',
    ansible_env.HOME + '/Library/Logs/sing-box.log'))
  }}

# ============================================================================
# Domain Lists (synchronized with router role)
# ============================================================================

# Список всех доступных доменов (должен совпадать с router_domains_lists)
local_domains_lists:
  - copilot
  - openai
  - google
  - datadog
  - instagram
  - netflix
  - telegram
  - claude
  - x
  - linkedin
  - windsurf
  - antigravity

# Включение/выключение доменов (аналогично router_domains)
local_domains:
  copilot: true
  openai: true
  google: true
  datadog: true
  instagram: true
  netflix: true
  telegram: false
  claude: true
  x: true
  linkedin: true
  windsurf: true
  antigravity: true

# ============================================================================
# PAC File Configuration
# ============================================================================

local_pac_enabled: true
local_pac_validate_certs: true

# Внешние источники доменов (ipset/nftset формат)
local_pac_extra_sources:
  - "https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/inside-dnsmasq-ipset.lst"

# Services to exclude from PAC (patterns in downloaded list)
local_services_exclude:
  - kinovod
  - telegram

# ============================================================================
# sing-box Configuration
# ============================================================================

# Log level: trace, debug, info, warn, error, fatal, panic
local_singbox_log_level: info

# DNS servers for sing-box (routed through VPN)
local_singbox_dns_servers:
  - tag: bootstrap
    type: udp
    server: "8.8.8.8"
  - tag: google-doh
    type: https
    server: dns.google
    server_port: 443
    domain_resolver: bootstrap
  - tag: cloudflare-doh
    type: https
    server: cloudflare-dns.com
    server_port: 443
    domain_resolver: bootstrap

# TUN Configuration (только для mode: tun)
local_singbox_tun:
  interface_name: utun99
  address:
    - "172.16.250.1/30"
  mtu: 9000
  auto_route: true
  strict_route: false
  stack: system

# ============================================================================
# VLESS Outbound
# ============================================================================

# ВАЖНО: server, uuid, tls.server_name должны быть заданы в group_vars!
local_singbox_outbound:
  tag: vpn-out
  type: vless
  server: ""           # REQUIRED in group_vars
  server_port: 8443
  uuid: ""             # REQUIRED in group_vars
  flow: xtls-rprx-vision  # Optional, can be empty string to disable

  tls:
    enabled: true
    insecure: false
    server_name: ""    # REQUIRED in group_vars
    disable_sni: false

  utls:
    enabled: true
    fingerprint: random

  reality:
    enabled: false
    public_key: ""
    short_id: ""

# ============================================================================
# Docker Configuration (for local_runtime: docker)
# ============================================================================

local_docker_image: "ghcr.io/sagernet/sing-box:latest"
local_docker_container_name: "sing-box"
local_docker_restart_policy: "unless-stopped"
