---
# launchd-specific tasks for sing-box on macOS

- name: Ensure Homebrew is installed
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: local_homebrew_check
  failed_when: not local_homebrew_check.stat.exists

- name: Install sing-box via Homebrew
  community.general.homebrew:
    name: sing-box
    state: present

- name: Create LaunchAgents directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/Library/LaunchAgents"
    state: directory
    mode: "0755"

- name: Generate launchd plist
  ansible.builtin.template:
    src: com.sing-box.plist.j2
    dest: "{{ ansible_env.HOME }}/Library/LaunchAgents/com.sing-box.plist"
    mode: "0644"
  notify: Load sing-box (launchd)

- name: Check if sing-box is loaded
  ansible.builtin.command:
    cmd: launchctl list
  register: local_launchctl_list
  changed_when: false
  check_mode: false

- name: Load sing-box service
  ansible.builtin.command:
    cmd: launchctl load {{ ansible_env.HOME }}/Library/LaunchAgents/com.sing-box.plist
  when: "'com.sing-box' not in local_launchctl_list.stdout"
  changed_when: true
