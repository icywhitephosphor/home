---
# Domains configuration tasks

- name: Ensure dnsmasq.d directory exists
  ansible.builtin.file:
    path: /etc/dnsmasq.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Upload IPv4 domain lists
  ansible.builtin.copy:
    src: "ipv4/{{ item }}.lst"
    dest: "/etc/dnsmasq.d/{{ item }}-ipv4.lst"
    owner: root
    group: root
    mode: "0644"
    backup: false
  loop: "{{ router_domains_lists }}"
  loop_control:
    label: "{{ item }}"
  when:
    - item not in router_services_exclude
    - router_domains[item] | default(false)
  notify: Rebuild domains

- name: Upload IPv6 domain lists
  ansible.builtin.copy:
    src: "ipv6/{{ item }}.lst"
    dest: "/etc/dnsmasq.d/{{ item }}-ipv6.lst"
    owner: root
    group: root
    mode: "0644"
    backup: false
  loop: "{{ router_domains_lists }}"
  loop_control:
    label: "{{ item }}"
  when:
    - router_ipv6_enabled | default(false)
    - item not in router_services_exclude
    - router_domains[item] | default(false)
  notify: Rebuild domains

- name: Remove disabled IPv4 domain lists
  ansible.builtin.file:
    path: "/etc/dnsmasq.d/{{ item }}-ipv4.lst"
    state: absent
  loop: "{{ router_domains_lists }}"
  loop_control:
    label: "{{ item }}"
  when:
    - item in router_services_exclude or not (router_domains[item] | default(false))
  notify: Rebuild domains

- name: Remove disabled IPv6 domain lists
  ansible.builtin.file:
    path: "/etc/dnsmasq.d/{{ item }}-ipv6.lst"
    state: absent
  loop: "{{ router_domains_lists }}"
  loop_control:
    label: "{{ item }}"
  when:
    - not (router_ipv6_enabled | default(false))
      or item in router_services_exclude
      or not (router_domains[item] | default(false))
  notify: Rebuild domains

- name: Deploy getdomains script
  ansible.builtin.template:
    src: getdomains.sh.j2
    dest: /etc/init.d/getdomains
    owner: root
    group: root
    mode: "0755"
    backup: false
  notify: Rebuild domains

- name: Enable getdomains autostart
  ansible.builtin.command:
    cmd: /etc/init.d/getdomains enable
  changed_when: false
