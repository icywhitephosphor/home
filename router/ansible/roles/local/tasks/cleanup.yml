---
# Cleanup tasks

- name: Find old config backups
  ansible.builtin.find:
    paths: "{{ local_config_dir }}"
    patterns: "*.json.*"
    recurse: false
  register: _old_configs

- name: Remove old config backups (keep last 3)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ (_old_configs.files | sort(attribute='mtime') | list)[:-3] }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when: _old_configs.files | length > 3
