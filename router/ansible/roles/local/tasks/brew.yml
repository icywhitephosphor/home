---
- name: Ensure Homebrew is installed
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: local_homebrew_check
  failed_when: not local_homebrew_check.stat.exists

- name: Install sing-box via Homebrew
  ansible.builtin.command: /opt/homebrew/bin/brew install sing-box
  register: local_brew_install
  changed_when: "'Installing' in local_brew_install.stdout"
  failed_when: local_brew_install.rc != 0

- name: Ensure brew config dir exists
  ansible.builtin.file:
    path: "{{ local_brew_config_path | dirname }}"
    state: directory
    mode: "0755"
    recurse: true

- name: Copy config for brew service
  ansible.builtin.copy:
    src: "{{ local_config_dir }}/config.json"
    dest: "{{ local_brew_config_path }}"
    mode: "0600"
    remote_src: true
  register: local_brew_copy
  when: not ansible_check_mode

- name: Restart sing-box brew service (skipped in check mode)
  ansible.builtin.command: /opt/homebrew/bin/brew services restart sing-box
  changed_when: true
  when: not ansible_check_mode

