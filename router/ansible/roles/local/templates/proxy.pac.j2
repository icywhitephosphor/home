// {{ ansible_managed }}
// PAC (Proxy Auto-Configuration) for sing-box
// Generated: {{ ansible_date_time.iso8601 }}
// Domains: {{ pac_domains | length }}

function FindProxyForURL(url, host) {
    // Local addresses - DIRECT
    if (isPlainHostName(host) ||
        shExpMatch(host, "localhost") ||
        shExpMatch(host, "127.*") ||
        shExpMatch(host, "192.168.*") ||
        shExpMatch(host, "10.*") ||
        shExpMatch(host, "172.16.*") ||
        shExpMatch(host, "172.17.*") ||
        shExpMatch(host, "172.18.*") ||
        shExpMatch(host, "172.19.*") ||
        shExpMatch(host, "172.2?.*") ||
        shExpMatch(host, "172.30.*") ||
        shExpMatch(host, "172.31.*") ||
        shExpMatch(host, "*.local") ||
        shExpMatch(host, "*.localhost")) {
        return "DIRECT";
    }

    // VPN domains - use Set for O(1) lookup
    var vpnDomains = new Set({{ pac_domains | to_json }});

    // Check exact match
    if (vpnDomains.has(host)) {
        return "PROXY 127.0.0.1:{{ local_proxy_http_port }}; DIRECT";
    }

    // Check parent domains (e.g., api.openai.com -> openai.com)
    var parts = host.split('.');
    for (var i = 1; i < parts.length - 1; i++) {
        var parent = parts.slice(i).join('.');
        if (vpnDomains.has(parent)) {
            return "PROXY 127.0.0.1:{{ local_proxy_http_port }}; DIRECT";
        }
    }

    return "DIRECT";
}
