#!/bin/sh /etc/rc.common
# {{ ansible_managed }}

START=99

start () {
    # Всё храним в /etc/dnsmasq.d/ (persistent storage)
    DOMAINS=https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/inside-dnsmasq-nfset.lst
    count=0
    while true; do
        if curl -m 3 github.com; then
            curl -f $DOMAINS --output /etc/dnsmasq.d/domains.lst
            break
        else
            echo "GitHub is not available. Check the internet availability [$count]"
            count=$((count+1))
        fi
    done
    sed -i '/kinovod/d' /etc/dnsmasq.d/domains.lst

    # Добавляем локальные файлы из /etc/dnsmasq.d/
{% for domain in router_domains_lists %}
{% if vars['router_domains_' + domain.name] | default(false) %}
    [ -f /etc/dnsmasq.d/{{ domain.file }} ] && cat /etc/dnsmasq.d/{{ domain.file }} >> /etc/dnsmasq.d/domains.lst
{% endif %}
{% endfor %}

    # Удаляем дубликаты
    sort -u /etc/dnsmasq.d/domains.lst -o /etc/dnsmasq.d/domains.lst
    
    # Перезапускаем dnsmasq
    /etc/init.d/dnsmasq restart
}
