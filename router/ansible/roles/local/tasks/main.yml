---
# Main tasks for local role (macOS sing-box)

- name: Validate macOS
  ansible.builtin.assert:
    that:
      - ansible_facts['os_family'] == "Darwin"
    fail_msg: "This role only supports macOS"

- name: Check Homebrew installed
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: _homebrew_check

- name: Fail if Homebrew not installed
  ansible.builtin.fail:
    msg: |
      Homebrew is not installed. Install it first:
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  when: not _homebrew_check.stat.exists

- name: Validate VPN servers configured
  ansible.builtin.assert:
    that:
      - local_singbox_servers | length > 0
    fail_msg: "VPN servers not configured in localhost.yml"

- name: Create config directory
  ansible.builtin.file:
    path: "{{ local_config_dir }}"
    state: directory
    mode: "0755"

# Parse domain lists from router role
- name: Parse domain lists
  ansible.builtin.include_tasks: domains.yml

# Generate PAC file
- name: Generate PAC file
  ansible.builtin.include_tasks: pac.yml
  when: local_pac_enabled | default(true)

# Generate sing-box config
- name: Generate sing-box configuration
  ansible.builtin.template:
    src: config.json.j2
    dest: "{{ local_config_dir }}/config.json"
    mode: "0600"
    backup: true
  register: _config_changed

- name: Validate sing-box configuration
  ansible.builtin.command:
    cmd: /opt/homebrew/bin/sing-box check -c "{{ local_config_dir }}/config.json"
  changed_when: false
  when: _homebrew_check.stat.exists

# Install sing-box via Homebrew
- name: Install sing-box via Homebrew
  community.general.homebrew:
    name: sing-box
    state: present
  register: _brew_install

# Create run script
- name: Create run script
  ansible.builtin.copy:
    dest: "{{ local_run_script }}"
    mode: "0755"
    content: |
      #!/bin/bash
      set -e
      exec /opt/homebrew/bin/sing-box run -c "{{ local_config_dir }}/config.json"

# Cleanup
- name: Cleanup old files
  ansible.builtin.include_tasks: cleanup.yml

# Summary
- name: Configuration summary
  ansible.builtin.debug:
    msg: |
      sing-box configured successfully.

      Config: {{ local_config_dir }}/config.json
      PAC:    {{ local_pac_path }}
      Proxy:  127.0.0.1:{{ local_proxy_port }}

      Domains: {{ local_routing_domains | default([]) | length }}
      Servers: {{ local_singbox_servers | map(attribute='name') | join(', ') }}

      Start: {{ local_run_script }}
      
      WiFi Settings → Proxies → Auto Proxy Configuration:
      file://{{ local_pac_path }}
